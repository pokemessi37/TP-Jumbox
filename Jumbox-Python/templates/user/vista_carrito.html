<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Carrito · JUMBOX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
</head>
<body>

<header class="main-header">
    <div class="logo">
        <a href="{{ url_for('main.home') }}">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Jumbox">
        </a>
    </div>

    <div class="categorias" tabindex="0">
      <div class="cat-btn">
          <i class="fa-solid fa-bars"></i>
          <span>CATEGORÍAS</span>
          <i class="fa-solid fa-chevron-down"></i>
      </div>
      <ul class="menu-desplegable" aria-hidden="true">
          <li {% if not categoria_actual %}class="categoria-activa"{% endif %}>
              <a href="{{ url_for('main.home') }}">Todos</a>
          </li>
          {% for categoria in categorias or [] %}
          <li {% if categoria_actual == categoria %}class="categoria-activa"{% endif %}>
              <a href="{{ url_for('main.home', categoria=categoria) }}">{{ categoria }}</a>
          </li>
          {% endfor %}
      </ul>
    </div>

    <div class="busqueda">
        <form method="GET" action="{{ url_for('main.home') }}" style="display: flex; width: 100%;">
            <input type="text" name="q" placeholder="Buscar productos...">
            <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
        </form>
    </div>

    <div class="cuenta" tabindex="0">
        <div class="cuenta-btn">
            <i class="fa-solid fa-user"></i> <span>Cuenta</span> <i class="fa-solid fa-chevron-down"></i>
        </div>
        <ul class="menu-cuenta" aria-hidden="true">
          {% if session.get('id_cliente') %}
          {% if session.get('tipo') == 'admin' %}
              <li><a href="{{ url_for('admin.admin') }}">Admin</a></li>
              <li><a href="{{ url_for('auth.logout') }}">Cerrar sesión</a></li>

          {% elif session.get('tipo') == 'sucursal' %}
              <li><a href="{{ url_for('sucursal.panel_sucursal') }}">Panel Sucursal</a></li>
              <li><a href="{{ url_for('auth.logout') }}">Cerrar sesión</a></li>

          {% else %}
              <li><a href="{{ url_for('user.mis_compras') }}">Mis Compras</a></li>
              <li><a href="{{ url_for('auth.logout') }}">Cerrar sesión</a></li>
          {% endif %}

      {% else %}
          <li><a href="{{ url_for('auth.registro') }}">Registrarse</a></li>
          <li><a href="{{ url_for('auth.login') }}">Iniciar sesión</a></li>
      {% endif %}
        </ul>
    </div>

    <div class="carrito">
        <a href="#"><i class="fa-solid fa-cart-shopping"></i>MI CARRITO</a>
    </div>
</header>



<div class="mensajes-flash">
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
          {% for category, message in messages %}
              <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
      {% endif %}
  {% endwith %}
</div>



<main class="contenedor">
  <h2><i class="fa-solid fa-shopping-cart"></i> Mi Carrito</h2>

  <!-- Items -->
  <section class="card">
    <h3>Productos en el carrito</h3>
    <div class="tabla-wrapper">
      <table class="tabla">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="right">Precio</th>
            <th class="center">Cantidad</th>
            <th class="right">Subtotal</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% if items and items|length %}
          {% for it in items %}
          <tr>
            <td>{{ it.nombre }}</td>

            <td class="right">${{ it.precio }}</td>

            <td class="center">
              <form method="post" action="{{ url_for('user.carrito_actualizar_item') }}"
                    style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <input type="hidden" name="producto_id" value="{{ it.producto_id }}">
                <input type="number" name="cantidad" min="1" step="1" value="{{ it.cantidad }}"
                      style="width:70px; padding: 6px;">
                <button class="btn" style="padding: 6px 12px; font-size: 13px;">
                  <i class="fa-solid fa-sync"></i>
                </button>
              </form>
            </td>

            <td class="right">${{ it.subtotal }}</td>

            <td class="right">
              <form method="post" action="{{ url_for('user.carrito_eliminar_item') }}">
                <input type="hidden" name="producto_id" value="{{ it.producto_id }}">
                <button class="btn danger">
                  <i class="fa-solid fa-trash"></i> Eliminar
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="center">Tu carrito está vacío.</td></tr>
        {% endif %}
        </tbody>

        {% if items and items|length %}
        <tfoot>
          <tr>
            <td colspan="3" class="right"><strong>Subtotal productos:</strong></td>
            <td class="right"><strong>${{ subtotal or 0 }}</strong></td>
            <td></td>
          </tr>

          <tr>
            <td colspan="3" class="right"><strong>Costo de envío:</strong></td>
            <td class="right">${{ costo_envio }}</td>
            <td></td>
          </tr>

          <tr class="fila-total">
            <td colspan="3" class="right"><strong>TOTAL A PAGAR:</strong></td>
            <td class="right total-cell"><strong>${{ total or 0 }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
        {% endif %}
      </table>
    </div>
  </section>



  <!-- Checkout -->
  <section class="card">
    <h3><i class="fa-solid fa-credit-card"></i> Finalizar compra</h3>
    <form method="post" action="{{ url_for('user.carrito_checkout') }}" id="formCheckout">
      <div class="grid">
        <div>
          <label><strong>Método de pago</strong></label>
          <select name="metodo_pago" id="metodoPago" required onchange="toggleFormularioTarjeta()">
            <option value="">Seleccionar...</option>
            {% for mp in metodos_pago or ['EFECTIVO','TARJETA'] %}
              <option value="{{ mp }}">{{ mp }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Formulario de Tarjeta -->
      <div id="formularioTarjeta" style="display: none; margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h4 style="margin-top: 0; color: #333; margin-bottom: 20px;">
          <i class="fa-solid fa-credit-card"></i> Datos de la tarjeta
        </h4>

        <div class="grid grid2">
          <div style="grid-column: 1/-1;">
            <label><strong>Número de tarjeta</strong></label>
            <input type="text" name="numero_tarjeta" placeholder="1234 5678 9012 3456">
          </div>

          <div style="grid-column: 1/-1;">
            <label><strong>Nombre del titular</strong></label>
            <input type="text" name="nombre_titular" placeholder="JUAN PEREZ">
          </div>

          <div>
            <label><strong>Fecha de vencimiento</strong></label>
            <input type="text" name="fecha_vencimiento" placeholder="MM/AA">
          </div>

          <div>
            <label><strong>CVV</strong></label>
            <input type="text" name="cvv" placeholder="123">
          </div>
        </div>

      </div>

      <div style="margin-top: 20px;">
        <label><strong>Observaciones (opcional)</strong></label>
        <textarea name="observaciones" rows="3" placeholder="Indicaciones especiales para la entrega..."></textarea>
      </div>

      <div style="margin-top: 20px;">
        <button class="btn primary" type="submit" {% if not items or not items|length %}disabled{% endif %}>
          <i class="fa-solid fa-check-circle"></i> Confirmar compra
        </button>
        <a href="{{ url_for('main.home') }}" class="btn" style="margin-left: 10px;">
          <i class="fa-solid fa-arrow-left"></i> Seguir comprando
        </a>
      </div>
    </form>
  </section>

</main>

<footer>
  <p>© 2025 Jumbox. Todos los derechos reservados.</p>
</footer>

<script>
  function toggleFormularioTarjeta() {
    const metodo = document.getElementById('metodoPago').value;
    const formTarjeta = document.getElementById('formularioTarjeta');
    const inputs = formTarjeta.querySelectorAll("input");

    if (metodo === "TARJETA") {
      formTarjeta.style.display = "block";
      inputs.forEach(i => i.required = true);
    } else {
      formTarjeta.style.display = "none";
      inputs.forEach(i => {
        i.required = false;
        i.value = "";
      });
    }
  }
</script>

</body>
</html>
